<!DOCTYPE html>
<html lang="en" color-mode="light">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="author" content="owenqing" />
  <!-- Open Graph Description 简短摘要-->
  
      <!-- 用于搜索引擎的文章摘要 -->
      
            
                
                  <title>
                    
                      理解 Golang 内存结构
                        
                              
                                    |
                                    
                                      owenqing
                  </title>

                  
                    <link rel="apple-touch-icon" href="/images/ai.jpg">
                    <link rel="icon" href="/images/ai.jpg">
                    

                      <!-- Noto Sans SC for harmonious CJK/Latin mixing -->
                      <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500&display=swap"
                        rel="stylesheet">
                      <!-- Raleway-Font (kept for legacy) -->
                      <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

                      <!-- hexo site css -->
                      <link rel="stylesheet" href="/css/main.css" />
                      <link rel="stylesheet" href="/css/zen.css?v=1758718186203" />
                      <link rel="stylesheet" href="/css/typography-fix.css" />
                      <link rel="stylesheet" href="/css/code-block-enhanced.css" />
                      <link rel="stylesheet" href="/css/mobile-nav.css" />
                      <link rel="stylesheet" href="//at.alicdn.com/t/font_1886449_67xjft27j1l.css" />
                      <!-- 代码块风格 -->
                      

                            <!-- jquery3.3.1 -->
                            
                                <script defer type="text/javascript" src="/plugins/jquery.min.js"></script>
                                

                                  <!-- fancybox -->
                                  
                                      <link href="/plugins/jquery.fancybox.min.css" rel="stylesheet">
                                      <script defer type="text/javascript"
                                        src="/plugins/jquery.fancybox.min.js"></script>
                                      
                                        
<script src="/js/fancybox.js"></script>


                                          

                                              

                                                  <script>
                                                    var html = document.documentElement
                                                    const colorMode = localStorage.getItem('color-mode')
                                                    if (colorMode) {
                                                      document.documentElement.setAttribute('color-mode', colorMode)
                                                    }
                                                  </script>

                                                  <link rel="stylesheet" href="/css/code-fix.css">
                                                  <link rel="stylesheet" href="/css/code-block-fix.css">
                                                  <link rel="stylesheet" href="/css/code-border-fix.css">

                                                  <!-- 添加header效果脚本 -->
                                                  <!-- <script defer type="text/javascript" src="/js/headerEffect.js"></script> -->

                                                  <link rel="stylesheet" href="/css/header-fix.css">
<meta name="generator" content="Hexo 7.3.0"></head>

  <body>
    <div id="app">
      <div class="header"
  style="position:fixed !important; top:0 !important; left:0 !important; right:0 !important; width:100% !important;">
  <div class="navbar">
    <nav class="navbar">
      <a href="/" class="blog-title">
        <span class="outer-orbit"></span>
        <span class="electron"></span>
        <span class="electron-yellow"></span>
        owenqing posts
      </a>
      
      <!-- Mobile menu toggle button -->
      <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
        <span class="hamburger"></span>
        <span class="hamburger"></span>
        <span class="hamburger"></span>
        <span class="toggle-text">Menu</span>
      </button>
      
      <ul class="nav-menu">
        
          
            <li class="active">
              <a href="/">
                
                    Home
              </a>
            </li>
            
              
          
              
          
              
          
            <li class="">
              <a href="/tags/">
                
                    Tags
              </a>
            </li>
            
              
          
            <li class="">
              <a href="/friends/">
                
                    Friends
              </a>
            </li>
            
              
          
            <li class="">
              <a href="/about/">
                
                    About
              </a>
            </li>
            
              
      </ul>
    </nav>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const navToggle = document.querySelector('.nav-toggle');
    const navMenu = document.querySelector('.nav-menu');
    const toggleText = document.querySelector('.toggle-text');
    
    if (navToggle && navMenu) {
      navToggle.addEventListener('click', function(e) {
        e.stopPropagation();
        navMenu.classList.toggle('nav-menu-active');
        const isOpen = navMenu.classList.contains('nav-menu-active');
        navToggle.setAttribute('aria-expanded', isOpen);
        toggleText.textContent = isOpen ? 'Close' : 'Menu';
        navToggle.classList.toggle('active', isOpen);
        
        // Prevent body scroll when menu is open
        if (isOpen) {
          document.body.classList.add('hidden');
        } else {
          document.body.classList.remove('hidden');
        }
      });
      
      // Close menu when clicking outside
      document.addEventListener('click', function(e) {
        if (!navToggle.contains(e.target) && !navMenu.contains(e.target)) {
          navMenu.classList.remove('nav-menu-active');
          navToggle.setAttribute('aria-expanded', 'false');
          toggleText.textContent = 'Menu';
          navToggle.classList.remove('active');
          document.body.classList.remove('hidden');
        }
      });
      
      // Close menu when clicking on a nav link
      const navLinks = document.querySelectorAll('.nav-menu a');
      navLinks.forEach(link => {
        link.addEventListener('click', function() {
          navMenu.classList.remove('nav-menu-active');
          navToggle.setAttribute('aria-expanded', 'false');
          toggleText.textContent = 'Menu';
          navToggle.classList.remove('active');
          document.body.classList.remove('hidden');
        });
      });
      
      // Close menu on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && navMenu.classList.contains('nav-menu-active')) {
          navMenu.classList.remove('nav-menu-active');
          navToggle.setAttribute('aria-expanded', 'false');
          toggleText.textContent = 'Menu';
          navToggle.classList.remove('active');
          document.body.classList.remove('hidden');
        }
      });
      
      // Handle window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
          navMenu.classList.remove('nav-menu-active');
          navToggle.setAttribute('aria-expanded', 'false');
          toggleText.textContent = 'Menu';
          navToggle.classList.remove('active');
          document.body.classList.remove('hidden');
        }
      });
    }
  });
</script>

        <div class="flex-container">
          <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->


  <!-- LaTex Display -->

  
    <script async type="text/javascript" src="/plugins/mathjax/tex-chtml.js"></script>
  
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      }
    }
  </script>


    

      
        <!-- clipboard -->

  
    <script async type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.10/dist/clipboard.min.js"></script>
  
  
<script src="/js/codeCopy.js"></script>



          

            

                

                    

                        

                            
                              <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
                              <div class="container post-details" id="post-details">
                                <div class="post-content">
                                  <div class="post-title">理解 Golang 内存结构</div>
                                  <div class="post-attach">
                                    <span class="post-pubtime">
                                      <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
                                      2025-05-13 22:35:32
                                    </span>
                                    
                                  </div>
                                  <div class="markdown-body">
                                    <h2 id="1-golang-memory-model"><a href="#1-golang-memory-model" class="headerlink" title="1. golang memory model"></a>1. golang memory model</h2><?xml version="1.0" encoding="UTF-8"?>
<svg viewBox="0 0 800 600" xmlns="http://www.w3.org/2000/svg">
  <!-- 内存布局部分 -->
  <rect x="50" y="70" width="700" height="180" fill="#e9ecef" stroke="#adb5bd" stroke-width="2" rx="5" />
  <text x="400" y="90" font-family="Arial" font-size="18" text-anchor="middle" font-weight="bold" fill="#495057">虚拟内存布局</text>

  <!-- 内存区域示意图 -->
  <rect x="100" y="110" width="600" height="30" fill="#4dabf7" stroke="#339af0" stroke-width="1" />
  <text x="400" y="130" font-family="Arial" font-size="14" text-anchor="middle" fill="white">spans区域 (spans)</text>

  <rect x="100" y="150" width="600" height="30" fill="#74c0fc" stroke="#4dabf7" stroke-width="1" />
  <text x="400" y="170" font-family="Arial" font-size="14" text-anchor="middle" fill="white">bitmap区域 (GC标记位图)</text>

  <rect x="100" y="190" width="600" height="40" fill="#a5d8ff" stroke="#74c0fc" stroke-width="1" />
  <text x="400" y="215" font-family="Arial" font-size="14" text-anchor="middle" fill="#212529">arena区域 (所有被管理内存，按8KB页划分)</text>

  <!-- 内存分配层次图 -->
  <rect x="50" y="270" width="700" height="310" fill="#e9ecef" stroke="#adb5bd" stroke-width="2" rx="5" />
  <text x="400" y="290" font-family="Arial" font-size="18" text-anchor="middle" font-weight="bold" fill="#495057">内存分配层次结构</text>

  <!-- mheap (顶层) -->
  <rect x="100" y="310" width="600" height="70" fill="#ffa8a8" stroke="#ff6b6b" stroke-width="2" rx="5" />
  <text x="400" y="335" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#212529">mheap (全局堆)</text>
  <text x="400" y="360" font-family="Arial" font-size="12" text-anchor="middle" fill="#212529">管理所有内存页, 包含120个span class, 向OS申请内存</text>

  <!-- mcentral (中间层) -->
  <rect x="150" y="400" width="500" height="70" fill="#ffd8a8" stroke="#ffc078" stroke-width="2" rx="5" />
  <text x="400" y="425" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#212529">mcentral (中央缓存)</text>
  <text x="400" y="450" font-family="Arial" font-size="12" text-anchor="middle" fill="#212529">每个size class对应一个mcentral, 管理empty和nonempty两种span链表</text>

  <!-- mcache (底层) -->
  <rect x="175" y="490" width="140" height="70" fill="#b2f2bb" stroke="#69db7c" stroke-width="2" rx="5" />
  <text x="245" y="515" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#212529">mcache (P1)</text>
  <text x="245" y="540" font-family="Arial" font-size="12" text-anchor="middle" fill="#212529">本地缓存</text>

  <rect x="330" y="490" width="140" height="70" fill="#b2f2bb" stroke="#69db7c" stroke-width="2" rx="5" />
  <text x="400" y="515" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#212529">mcache (P2)</text>
  <text x="400" y="540" font-family="Arial" font-size="12" text-anchor="middle" fill="#212529">本地缓存</text>

  <rect x="485" y="490" width="140" height="70" fill="#b2f2bb" stroke="#69db7c" stroke-width="2" rx="5" />
  <text x="555" y="515" font-family="Arial" font-size="16" text-anchor="middle" font-weight="bold" fill="#212529">mcache (Pn)</text>
  <text x="555" y="540" font-family="Arial" font-size="12" text-anchor="middle" fill="#212529">本地缓存</text>

  <!-- 连接线 -->
  <line x1="400" y1="380" x2="400" y2="400" stroke="#495057" stroke-width="2" stroke-dasharray="5,3" />
  <polygon points="400,400 395,390 405,390" fill="#495057" />

  <line x1="400" y1="470" x2="400" y2="490" stroke="#495057" stroke-width="2" stroke-dasharray="5,3" />
  <polygon points="400,490 395,480 405,480" fill="#495057" />

  <line x1="400" y1="470" x2="245" y2="490" stroke="#495057" stroke-width="2" stroke-dasharray="5,3" />
  <polygon points="245,490 253,484 255,495" fill="#495057" />

  <line x1="400" y1="470" x2="555" y2="490" stroke="#495057" stroke-width="2" stroke-dasharray="5,3" />
  <polygon points="555,490 547,484 545,495" fill="#495057" />
</svg>

<h2 id="2-mcache-mcentral-mheap"><a href="#2-mcache-mcentral-mheap" class="headerlink" title="2. mcache, mcentral, mheap"></a>2. mcache, mcentral, mheap</h2><p><img src="data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22UTF-8%22%3F%3E%3Csvg%20viewBox%3D%220%200%20900%201200%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3C!--%20mheap%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20--%3E%3Crect%20x%3D%2250%22%20y%3D%2260%22%20width%3D%22800%22%20height%3D%22350%22%20fill%3D%22%23ffdeeb%22%20stroke%3D%22%23ff8fa3%22%20stroke-width%3D%222%22%20rx%3D%225%22%20%2F%3E%3Ctext%20x%3D%22450%22%20y%3D%2285%22%20font-family%3D%22Arial%22%20font-size%3D%2220%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Emheap%20%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3Crect%20x%3D%2280%22%20y%3D%22100%22%20width%3D%22740%22%20height%3D%22290%22%20fill%3D%22%23fff0f6%22%20stroke%3D%22%23fcc2d7%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3C!--%20mheap%20%E5%86%85%E9%83%A8%E5%AD%97%E6%AE%B5%20--%3E%3Crect%20x%3D%22100%22%20y%3D%22120%22%20width%3D%22330%22%20height%3D%22250%22%20fill%3D%22%23fff%22%20stroke%3D%22%23ffa8b4%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22265%22%20y%3D%22140%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Emheap%20%E4%B8%BB%E8%A6%81%E5%AD%97%E6%AE%B5%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22160%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3Etype%20mheap%20struct%20%7B%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22180%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20lock%20mutex%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%BF%9D%E6%8A%A4%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22200%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20pages%20pageAlloc%20%20%20%20%20%2F%2F%20%E9%A1%B5%E5%88%86%E9%85%8D%E5%99%A8%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22220%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20central%20%5BnumSpanClasses%5D%5BnumShards%5Dstruct%20%7B%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22240%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20%20%20mcentral%20mcentral%20%20%2F%2F%20%E8%BF%9E%E6%8E%A5mcentral%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22260%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20%20%20pad%20%20%20%20%20%20%5Bcpu.CacheLinePadSize%5Dbyte%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22280%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20%7D%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22300%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20arenas%20%5B1%20%26lt%3B%26lt%3B%20arenaL1Bits%5D*%5B1%20%26lt%3B%26lt%3B%20arenaL2Bits%5D*heapArena%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22320%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20allspans%20%5B%5D*mspan%20%20%20%2F%2F%20%E6%89%80%E6%9C%89%E7%9A%84span%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22340%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20sweepSpans%20%5B2%5DgcSweepBuf%20%2F%2F%20%E7%AD%89%E5%BE%85%E6%B8%85%E6%89%AB%E7%9A%84mspan%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22360%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%7D%3C%2Ftext%3E%3C!--%20mheap%20spans%20%E7%BB%93%E6%9E%84%20--%3E%3Crect%20x%3D%22450%22%20y%3D%22120%22%20width%3D%22350%22%20height%3D%22250%22%20fill%3D%22%23fff%22%20stroke%3D%22%23ffa8b4%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22625%22%20y%3D%22140%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Espans%20%E5%92%8C%20arenas%20%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3C!--%20spans%E7%BB%84%E7%BB%87%20--%3E%3Crect%20x%3D%22470%22%20y%3D%22160%22%20width%3D%22310%22%20height%3D%2280%22%20fill%3D%22%23fff0f6%22%20stroke%3D%22%23ffa8b4%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22625%22%20y%3D%22180%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eallspans%3A%20%E8%BF%BD%E8%B8%AA%E6%89%80%E6%9C%89%E7%9A%84span%3C%2Ftext%3E%3C!--%20arenas%E7%BB%84%E7%BB%87%20-%20%E5%A4%9A%E7%BA%A7%E6%98%A0%E5%B0%84%E7%BB%93%E6%9E%84%20--%3E%3Crect%20x%3D%22470%22%20y%3D%22260%22%20width%3D%22310%22%20height%3D%2290%22%20fill%3D%22%23fff0f6%22%20stroke%3D%22%23ffa8b4%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22625%22%20y%3D%22280%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Earenas%3A%20L1%E2%86%92L2%E2%86%92heapArena%20%E5%A4%9A%E7%BA%A7%E6%98%A0%E5%B0%84%3C%2Ftext%3E%3Ctext%20x%3D%22625%22%20y%3D%22300%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3EheapArena%E5%AD%98%E5%82%A8%E5%AE%9E%E9%99%85%E5%86%85%E5%AD%98%E9%A1%B5%E5%92%8C%E5%85%83%E6%95%B0%E6%8D%AE%3C%2Ftext%3E%3Ctext%20x%3D%22625%22%20y%3D%22320%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E%E6%AF%8F%E4%B8%AAheapArena%E7%AE%A1%E7%90%8664MB%E5%86%85%E5%AD%98%3C%2Ftext%3E%3C!--%20mcentral%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20--%3E%3Crect%20x%3D%2250%22%20y%3D%22430%22%20width%3D%22800%22%20height%3D%22320%22%20fill%3D%22%23d3f9d8%22%20stroke%3D%22%2369db7c%22%20stroke-width%3D%222%22%20rx%3D%225%22%20%2F%3E%3Ctext%20x%3D%22450%22%20y%3D%22455%22%20font-family%3D%22Arial%22%20font-size%3D%2220%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Emcentral%20%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3Crect%20x%3D%2280%22%20y%3D%22470%22%20width%3D%22740%22%20height%3D%22260%22%20fill%3D%22%23ebfbee%22%20stroke%3D%22%238ce99a%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3C!--%20mcentral%20%E5%86%85%E9%83%A8%E5%AD%97%E6%AE%B5%20--%3E%3Crect%20x%3D%22100%22%20y%3D%22490%22%20width%3D%22330%22%20height%3D%22220%22%20fill%3D%22%23fff%22%20stroke%3D%22%238ce99a%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22265%22%20y%3D%22510%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Emcentral%20%E4%B8%BB%E8%A6%81%E5%AD%97%E6%AE%B5%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22530%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3Etype%20mcentral%20struct%20%7B%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22550%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20lock%20mutex%20%20%20%20%20%20%20%20%20%20%2F%2F%20%E4%BF%9D%E6%8A%A4mcentral%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22570%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20spanclass%20spanClass%20%2F%2F%20span%E7%B1%BB%E5%88%AB%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22590%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20nonempty%20mSpanList%20%20%2F%2F%20%E9%9D%9E%E7%A9%BAspan%E9%93%BE%E8%A1%A8%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22610%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20empty%20mSpanList%20%20%20%20%20%2F%2F%20%E7%A9%BAspan%E9%93%BE%E8%A1%A8%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22630%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20nmalloc%20uint64%20%20%20%20%20%20%2F%2F%20%E5%B7%B2%E5%88%86%E9%85%8D%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%95%B0%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22650%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20nfree%20uint64%20%20%20%20%20%20%20%20%2F%2F%20%E5%B7%B2%E9%87%8A%E6%94%BE%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%95%B0%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22670%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%7D%3C%2Ftext%3E%3C!--%20mcentral%20%E9%93%BE%E8%A1%A8%E7%BB%93%E6%9E%84%E7%A4%BA%E6%84%8F%E5%9B%BE%20--%3E%3Crect%20x%3D%22450%22%20y%3D%22490%22%20width%3D%22350%22%20height%3D%22220%22%20fill%3D%22%23fff%22%20stroke%3D%22%238ce99a%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22625%22%20y%3D%22510%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3EmSpanList%20%E9%93%BE%E8%A1%A8%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3C!--%20nonempty%20%E9%93%BE%E8%A1%A8%20--%3E%3Crect%20x%3D%22470%22%20y%3D%22530%22%20width%3D%2280%22%20height%3D%2230%22%20fill%3D%22%23c3fae8%22%20stroke%3D%22%2363e6be%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22510%22%20y%3D%22550%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Enonempty%3C%2Ftext%3E%3Crect%20x%3D%22570%22%20y%3D%22530%22%20width%3D%2260%22%20height%3D%2230%22%20fill%3D%22%2399e9f2%22%20stroke%3D%22%233bc9db%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22600%22%20y%3D%22550%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Emspan%3C%2Ftext%3E%3Crect%20x%3D%22650%22%20y%3D%22530%22%20width%3D%2260%22%20height%3D%2230%22%20fill%3D%22%2399e9f2%22%20stroke%3D%22%233bc9db%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22680%22%20y%3D%22550%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Emspan%3C%2Ftext%3E%3Crect%20x%3D%22730%22%20y%3D%22530%22%20width%3D%2250%22%20height%3D%2230%22%20fill%3D%22%2399e9f2%22%20stroke%3D%22%233bc9db%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22755%22%20y%3D%22550%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E...%3C%2Ftext%3E%3C!--%20empty%20%E9%93%BE%E8%A1%A8%20--%3E%3Crect%20x%3D%22470%22%20y%3D%22580%22%20width%3D%2280%22%20height%3D%2230%22%20fill%3D%22%23c3fae8%22%20stroke%3D%22%2363e6be%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22510%22%20y%3D%22600%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eempty%3C%2Ftext%3E%3Crect%20x%3D%22570%22%20y%3D%22580%22%20width%3D%2260%22%20height%3D%2230%22%20fill%3D%22%2399e9f2%22%20stroke%3D%22%233bc9db%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22600%22%20y%3D%22600%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Emspan%3C%2Ftext%3E%3Crect%20x%3D%22650%22%20y%3D%22580%22%20width%3D%2260%22%20height%3D%2230%22%20fill%3D%22%2399e9f2%22%20stroke%3D%22%233bc9db%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22680%22%20y%3D%22600%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Emspan%3C%2Ftext%3E%3Crect%20x%3D%22730%22%20y%3D%22580%22%20width%3D%2250%22%20height%3D%2230%22%20fill%3D%22%2399e9f2%22%20stroke%3D%22%233bc9db%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22755%22%20y%3D%22600%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E...%3C%2Ftext%3E%3C!--%20%E8%BF%9E%E6%8E%A5%E7%BA%BF%20--%3E%3Cline%20x1%3D%22550%22%20y1%3D%22545%22%20x2%3D%22570%22%20y2%3D%22545%22%20stroke%3D%22%23495057%22%20stroke-width%3D%221%22%20%2F%3E%3Cline%20x1%3D%22630%22%20y1%3D%22545%22%20x2%3D%22650%22%20y2%3D%22545%22%20stroke%3D%22%23495057%22%20stroke-width%3D%221%22%20%2F%3E%3Cline%20x1%3D%22710%22%20y1%3D%22545%22%20x2%3D%22730%22%20y2%3D%22545%22%20stroke%3D%22%23495057%22%20stroke-width%3D%221%22%20%2F%3E%3Cline%20x1%3D%22550%22%20y1%3D%22595%22%20x2%3D%22570%22%20y2%3D%22595%22%20stroke%3D%22%23495057%22%20stroke-width%3D%221%22%20%2F%3E%3Cline%20x1%3D%22630%22%20y1%3D%22595%22%20x2%3D%22650%22%20y2%3D%22595%22%20stroke%3D%22%23495057%22%20stroke-width%3D%221%22%20%2F%3E%3Cline%20x1%3D%22710%22%20y1%3D%22595%22%20x2%3D%22730%22%20y2%3D%22595%22%20stroke%3D%22%23495057%22%20stroke-width%3D%221%22%20%2F%3E%3C!--%20mcache%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%20--%3E%3Crect%20x%3D%2250%22%20y%3D%22770%22%20width%3D%22800%22%20height%3D%22400%22%20fill%3D%22%23d0ebff%22%20stroke%3D%22%234dabf7%22%20stroke-width%3D%222%22%20rx%3D%225%22%20%2F%3E%3Ctext%20x%3D%22450%22%20y%3D%22795%22%20font-family%3D%22Arial%22%20font-size%3D%2220%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Emcache%20%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3Crect%20x%3D%2280%22%20y%3D%22810%22%20width%3D%22740%22%20height%3D%22340%22%20fill%3D%22%23e7f5ff%22%20stroke%3D%22%2374c0fc%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3C!--%20mcache%20%E5%86%85%E9%83%A8%E5%AD%97%E6%AE%B5%20--%3E%3Crect%20x%3D%22100%22%20y%3D%22830%22%20width%3D%22330%22%20height%3D%22300%22%20fill%3D%22%23fff%22%20stroke%3D%22%2374c0fc%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22265%22%20y%3D%22850%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Emcache%20%E4%B8%BB%E8%A6%81%E5%AD%97%E6%AE%B5%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22870%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3Etype%20mcache%20struct%20%7B%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22890%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20nextSample%20uintptr%20%20%20%20%20%2F%2F%20%E4%B8%8B%E4%B8%80%E4%B8%AA%E9%87%87%E6%A0%B7%E4%BD%8D%E7%BD%AE%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22910%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20alloc%20%5BnumSpanClasses%5D*mspan%20%20%2F%2F%20%E6%AF%8F%E4%B8%AA%E7%B1%BB%E5%88%AB%E7%BC%93%E5%AD%98%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22930%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%2F%2F%202%20*%2067%20%3D%20134%E4%B8%AAspan%E6%A7%BD%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22950%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20tiny%20uintptr%20%20%20%20%20%20%20%20%20%2F%2F%20%E5%B0%8F%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E5%99%A8%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22970%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20tinyoffset%20uintptr%20%20%20%2F%2F%20tiny%E5%88%86%E9%85%8D%E5%99%A8%E5%81%8F%E7%A7%BB%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%22990%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20tinyAllocs%20uintptr%20%20%20%2F%2F%20tiny%E5%88%86%E9%85%8D%E8%AE%A1%E6%95%B0%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%221010%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20local_scan%20uintptr%20%20%20%2F%2F%20%E6%89%AB%E6%8F%8F%E7%9A%84%E4%BB%BB%E5%8A%A1%E9%87%8F%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%221030%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20local_tinyAllocs%20uintptr%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%221050%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20local_largefree%20uintptr%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%221070%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20local_nlargefree%20uintptr%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%221090%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%20%20local_nsmallfree%20%5B_NumSizeClasses%5Duintptr%3C%2Ftext%3E%3Ctext%20x%3D%22110%22%20y%3D%221110%22%20font-family%3D%22Courier%20New%22%20font-size%3D%2212%22%20fill%3D%22%23333%22%3E%7D%3C%2Ftext%3E%3C!--%20mcache%20%E7%BC%93%E5%AD%98%E7%BB%93%E6%9E%84%E7%A4%BA%E6%84%8F%E5%9B%BE%20--%3E%3Crect%20x%3D%22450%22%20y%3D%22830%22%20width%3D%22350%22%20height%3D%22300%22%20fill%3D%22%23fff%22%20stroke%3D%22%2374c0fc%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22625%22%20y%3D%22850%22%20font-family%3D%22Arial%22%20font-size%3D%2214%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Ealloc%5BnumSpanClasses%5D%20%E7%BB%93%E6%9E%84%3C%2Ftext%3E%3Crect%20x%3D%22470%22%20y%3D%22870%22%20width%3D%22310%22%20height%3D%22240%22%20fill%3D%22%23e7f5ff%22%20stroke%3D%22%2374c0fc%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3C!--%20scan%20spans%20--%3E%3Ctext%20x%3D%22625%22%20y%3D%22890%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Escan%20spans%20(67%E4%B8%AA)%3C%2Ftext%3E%3Crect%20x%3D%22480%22%20y%3D%22900%22%20width%3D%2270%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22515%22%20y%3D%22920%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eclass%201%3C%2Ftext%3E%3Crect%20x%3D%22560%22%20y%3D%22900%22%20width%3D%2270%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22595%22%20y%3D%22920%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eclass%202%3C%2Ftext%3E%3Crect%20x%3D%22640%22%20y%3D%22900%22%20width%3D%2270%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22675%22%20y%3D%22920%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eclass%203%3C%2Ftext%3E%3Crect%20x%3D%22720%22%20y%3D%22900%22%20width%3D%2240%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22740%22%20y%3D%22920%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E...%3C%2Ftext%3E%3C!--%20noscan%20spans%20--%3E%3Ctext%20x%3D%22625%22%20y%3D%22960%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Enoscan%20spans%20(67%E4%B8%AA)%3C%2Ftext%3E%3Crect%20x%3D%22480%22%20y%3D%22970%22%20width%3D%2270%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22515%22%20y%3D%22990%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eclass%201%3C%2Ftext%3E%3Crect%20x%3D%22560%22%20y%3D%22970%22%20width%3D%2270%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22595%22%20y%3D%22990%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eclass%202%3C%2Ftext%3E%3Crect%20x%3D%22640%22%20y%3D%22970%22%20width%3D%2270%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22675%22%20y%3D%22990%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3Eclass%203%3C%2Ftext%3E%3Crect%20x%3D%22720%22%20y%3D%22970%22%20width%3D%2240%22%20height%3D%2230%22%20fill%3D%22%23a5d8ff%22%20stroke%3D%22%23339af0%22%20stroke-width%3D%221%22%20rx%3D%222%22%20%2F%3E%3Ctext%20x%3D%22740%22%20y%3D%22990%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E...%3C%2Ftext%3E%3C!--%20tiny%20allocator%20--%3E%3Crect%20x%3D%22480%22%20y%3D%221020%22%20width%3D%22290%22%20height%3D%2260%22%20fill%3D%22%23e7f5ff%22%20stroke%3D%22%2374c0fc%22%20stroke-width%3D%221%22%20rx%3D%223%22%20%2F%3E%3Ctext%20x%3D%22625%22%20y%3D%221040%22%20font-family%3D%22Arial%22%20font-size%3D%2212%22%20text-anchor%3D%22middle%22%20font-weight%3D%22bold%22%20fill%3D%22%23333%22%3Etiny%20allocator%3C%2Ftext%3E%3Ctext%20x%3D%22625%22%20y%3D%221060%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E%E7%94%A8%E4%BA%8E%E5%88%86%E9%85%8D%E5%B0%8F%E4%BA%8E16%E5%AD%97%E8%8A%82%E7%9A%84%E5%AF%B9%E8%B1%A1%3C%2Ftext%3E%3Ctext%20x%3D%22625%22%20y%3D%221075%22%20font-family%3D%22Arial%22%20font-size%3D%2210%22%20text-anchor%3D%22middle%22%20fill%3D%22%23333%22%3E%E9%81%BF%E5%85%8D%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87%EF%BC%8C%E6%8F%90%E9%AB%98%E5%86%85%E5%AD%98%E5%88%A9%E7%94%A8%E7%8E%87%3C%2Ftext%3E%3C%2Fsvg%3E"></p>
<p>Go 语言采用了一套精心设计的内存分配和管理系统，以提高内存分配的效率并减少垃圾回收的开销。这个系统主要由三个核心组件构成：mcache、mcentral 和 mheap。</p>
<h3 id="初始化的内存结构"><a href="#初始化的内存结构" class="headerlink" title="初始化的内存结构"></a>初始化的内存结构</h3><p>Go 运行时在启动时会向操作系统申请一大块虚拟内存，并将其组织为一个多级结构：</p>
<ol>
<li><strong>arena 区域</strong>：Go 程序所有被管理的内存</li>
<li><strong>spans 区域</strong>：记录 arena 区域中哪些内存块已被分配</li>
<li><strong>bitmap 区域</strong>：用于垃圾回收，标记对象是否存活</li>
<li><strong>arena 区域</strong>被划分为大小为 8KB 的页(page)</li>
</ol>
<h3 id="内存管理组件及其工作原理"><a href="#内存管理组件及其工作原理" class="headerlink" title="内存管理组件及其工作原理"></a>内存管理组件及其工作原理</h3><h4 id="1-mcache"><a href="#1-mcache" class="headerlink" title="1. mcache"></a>1. mcache</h4><p><strong>mcache</strong>是与每个线程(P)关联的本地缓存：</p>
<ul>
<li>每个 mcache 维护 67 种大小类别的对象内存块(span)，称为 size class</li>
<li>这些 size class 8B, …，按 8B 倍数递增</li>
<li>mcache 中有两类 span：scan 和 noscan，取决于对象是否包含指针</li>
<li>线程分配内存时，直接从自己的 mcache 获取，无需锁，性能高效</li>
</ul>
<h4 id="2-mcentral"><a href="#2-mcentral" class="headerlink" title="2. mcentral"></a>2. mcentral</h4><p><strong>mcentral</strong>是全局的中央缓存：</p>
<ul>
<li>当 mcache 中某个 size class 的 span 用完时，会向 mcentral 申请</li>
<li>每个 mcentral 管理特定 size class 的 span</li>
<li>mcentral 维护两个链表：empty(已分配)和 nonempty(有空闲对象)</li>
<li>操作 mcentral 需要加锁，因为它被所有线程共享</li>
</ul>
<h4 id="3-mheap"><a href="#3-mheap" class="headerlink" title="3. mheap"></a>3. mheap</h4><p><strong>mheap</strong>是最顶层的内存管理组件：</p>
<ul>
<li>当 mcentral 无法满足申请时，mheap 会分配新的 span</li>
<li>mheap 管理操作系统未分配的内存页</li>
<li>mheap 通过系统调用(如 mmap)向操作系统申请内存</li>
</ul>
<h3 id="最大内存管理能力"><a href="#最大内存管理能力" class="headerlink" title="最大内存管理能力"></a>最大内存管理能力</h3><p>Go 的内存管理系统理论上可以管理的最大内存是：</p>
<ul>
<li>在 64 位系统上：最多支持 512GB(虚拟内存地址空间)</li>
<li>在 32 位系统上：最多支持 4GB</li>
</ul>
<p>但实际上，Go 1.11 之后引入了物理内存映射技术，理论上可以管理的内存可达操作系统和硬件支持的最大值。</p>
<h3 id="内存分配流程"><a href="#内存分配流程" class="headerlink" title="内存分配流程"></a>内存分配流程</h3><ol>
<li><strong>微小对象</strong>(&lt;16B)：直接在 mcache 的 tiny allocator 中分配</li>
<li><strong>小对象</strong>(16B-32KB)：从 mcache 的相应 size class 获取</li>
<li><strong>中等对象</strong>(32KB-16MB)：直接从 mheap 获取 span</li>
<li><strong>大对象</strong>(&gt;16MB)：直接从 mheap 分配，且不被拆分</li>
</ol>
<h3 id="mcache、mcentral-和-mheap-的层级关系"><a href="#mcache、mcentral-和-mheap-的层级关系" class="headerlink" title="mcache、mcentral 和 mheap 的层级关系"></a>mcache、mcentral 和 mheap 的层级关系</h3><ol>
<li><strong>mcache</strong>：P 级别(处理器)缓存，无锁操作</li>
<li><strong>mcentral</strong>：全局缓存，需要锁保护</li>
<li><strong>mheap</strong>：全局堆管理，需要锁保护</li>
</ol>
<p>这种多级缓存的设计大大减少了锁竞争，提高了内存分配的效率，同时也便于垃圾回收器的工作。</p>

                                  </div>
                                  
                                    <div class="prev-or-next">
                                      <div class="post-foot-next">
                                        
                                          <a href="/2024/06/13/%E6%A8%A1%E5%9D%97%E5%8C%96%E8%AE%BE%E8%AE%A1%E4%B8%8E%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" target="_self">
                                            <i class="iconfont icon-chevronleft"></i>
                                            <span>
                                              Prev
                                            </span>
                                          </a>
                                          
                                      </div>
                                      <div class="post-attach">
                                        <span class="post-pubtime">
                                          <i class="iconfont icon-updatetime mr-10" title="Update time"></i>
                                          2025-05-13 22:35:32
                                        </span>
                                        
                                      </div>
                                      <div class="post-foot-prev">
                                        
                                      </div>
                                    </div>
                                    
                                </div>
                                

                                  
                                    <div class="comments-container">
                                      







                                    </div>
                                    
                              </div>
                              
            
  <div class="footer">
    <div class="social">
      <ul>
        
          <li>
            
                <a title="github" href="">
                  <i class="iconfont icon-github"></i>
                </a>
                
          </li>
          
          <li>
            
              <a title="email" href="mailto:">
                <i class="iconfont icon-envelope"></i>
              </a>
              
          </li>
          
      </ul>
    </div>
    
      
        <div class="footer-more">
          
              Copyright © 2025
                
        </div>
        
      
        <div class="footer-more">
          
              powered by owenqing
                
        </div>
        
          
  </div>
        </div>

        <div class="tools-bar">
          <div class="back-to-top tools-bar-item hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



            
  <div class="search-icon tools-bar-item" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




              


                
  
    <div class="share-icon tools-bar-item">
      <a href="javascript: void(0)" id="share-icon">
        <i class="iconfont iconshare"></i>
      </a>
      <div class="share-content hidden">
        
          <a class="share-item" href="https://twitter.com/intent/tweet?text=' + %E7%90%86%E8%A7%A3%20Golang%20%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84 + '&url=' + https%3A%2F%2Fowenqing.github.io%2F2025%2F05%2F12%2F%25E7%2590%2586%25E8%25A7%25A3%2520Golang%2520%25E5%2586%2585%25E5%25AD%2598%25E7%25BB%2593%25E6%259E%2584%2F + '" target="_blank" title="Twitter">
            <i class="iconfont icon-twitter"></i>
          </a>
        
        
          <a class="share-item" href="https://www.facebook.com/sharer.php?u=https://owenqing.github.io/2025/05/12/%E7%90%86%E8%A7%A3%20Golang%20%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84/" target="_blank" title="Facebook">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        
      </div>
    </div>
  
  
<script src="/js/shares.js"></script>



        </div>
    </div>
  </body>

</html>
<script src="https://cdn.jsdelivr.net/npm/mermaid@9.3.0/dist/mermaid.min.js"></script>
<script src="/js/mermaid-config.js"></script>